services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    user: "1000:1000"
    security_opt:
      - no-new-privileges:true
    environment:
      # 域名配置
      DOMAIN: "https://${VAULTWARDEN_HOST}"
      
      # 注册和邀请
      SIGNUPS_ALLOWED: "false"
      INVITATIONS_ALLOWED: "true"
      
      # Admin 页面
      ADMIN_TOKEN: "${ADMIN_TOKEN}"
      
      # WebSocket 实时同步
      WEBSOCKET_ENABLED: "true"
      
      # SMTP 邮件配置
      SMTP_HOST: "${SMTP_HOST}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_SECURITY: "${SMTP_SECURITY:-starttls}"
      SMTP_USERNAME: "${SMTP_USERNAME}"
      SMTP_PASSWORD: "${SMTP_PASSWORD}"
      SMTP_FROM: "${SMTP_FROM}"
      SMTP_FROM_NAME: "Vaultwarden"
      
      # 安全配置
      SHOW_PASSWORD_HINT: "false"
      
      # 日志
      LOG_LEVEL: "info"
      EXTENDED_LOGGING: "true"
      
      # 时区
      TZ: "${TZ:-Asia/Shanghai}"
    volumes:
      - ./data:/data
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      # HTTP 路由
      - "traefik.http.routers.vaultwarden.entrypoints=https"
      - "traefik.http.routers.vaultwarden.rule=Host(`${VAULTWARDEN_HOST}`)"
      - "traefik.http.routers.vaultwarden.tls=true"
      - "traefik.http.routers.vaultwarden.tls.certresolver=cloudflare"
      - "traefik.http.routers.vaultwarden.middlewares=chain-default@file"
      - "traefik.http.routers.vaultwarden.service=vaultwarden"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  traefik:
    external: true
